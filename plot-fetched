#!/bin/sh

#
#  ----------------------------------------------------
#  vsm - vector space model data similarity
#  ----------------------------------------------------
#
#  Copyright (c) 2008 Jason Bittel <jason.bittel@gmail.com>
#

# This script takes as input the fetched DB generated by
# fetch-hosts. It reads in the score data, assigns an
# incremental file number, and graphs the output with gnuplot.

if [ "$#" -ne 1 ] ; then
        echo "Error: Malformed parameter list" >&2
        echo "Usage: ${0} <fetch-db>" >&2
        echo "" >&2
        exit 1
fi

fetched_db=${1}
display_labels=0

if [ ! -r "${fetched_db}" ] ; then
        echo "Error: Cannot read from file '${fetched_db}'" >&2
        exit 1
fi

rm -f .temp_*

cat << 'EOF' > ".temp_plot"
set autoscale
set terminal png
set xlabel "file number"
set ylabel "similarity"
set title "Similarity of Fetched Files"
set key off
set output "similarity.png"
EOF

# Read fetched DB and extract score data
i=1
while read hostname filename date_fetched score ; do
        score_int=${score/.*}

        if [ ${score_int} -ne -1 ] ; then
                echo "${i} ${score}" >> ".temp_data"

                if [ ${display_labels} -ne 0 -a "${score}" != "0.0000" ] ; then
                        echo "set label \"${hostname}\" at ${i},${score}" >> ".temp_plot"
                fi

                i=$[${i} + 1]
        fi
done < "${fetched_db}"

echo "plot \".temp_data\" using 1:2 with points ps 0.2" >> ".temp_plot"

gnuplot < ".temp_plot"
rm -f .temp_*
